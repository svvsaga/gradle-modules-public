name: Publish packages
on:
  push:
    branches:
      - main
    paths:
      - "modules/**"
      - "plugins/**"
      - "!**/*.md"

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  RELEASE_VERSION: ${{ github.run_number }}
jobs:
  find-module-changes:
    name: Find module changes
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Find module changes
        id: find-module-changes
        uses: svvsaga/github-actions-public/find-gradle-module-changes@main
        with:
          include_all: ${{ github.event.inputs.include_all }}
          ignore_modules: ./example,.

    outputs:
      matrix: ${{ steps.find-module-changes.outputs.matrix }}
      has_results: ${{ steps.find-module-changes.outputs.has_results }}

  publish-packages:
    name: Publish packages
    needs: find-module-changes
    runs-on: ubuntu-latest
    if: needs.find-module-changes.outputs.has_results == 'true'
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.find-module-changes.outputs.matrix) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Bump semantic version
        uses: svvsaga/github-actions-public/bump-semver-tag@v3.9.0
        id: bump-semver-tag

      - name: Cache Gradle packages
        uses: actions/cache@v2
        if: ${{ steps.bump-semver-tag.outputs.tag != '' }}
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@master
        if: ${{ steps.bump-semver-tag.outputs.tag != '' }}
        with:
          version: latest
          service_account_key: ${{ secrets.GCP_SA_ARTIFACT_PUBLISHER }}
          export_default_credentials: true

      - name: Publish packages
        if: ${{ steps.bump-semver-tag.outputs.tag != '' }}
        run: ./gradlew publish -PreleaseVersion=${{ steps.bump-semver-tag.outputs.version }}
        working-directory: ${{ matrix.path }}

      - name: Push tag
        if: ${{ steps.bump-semver-tag.outputs.tag != '' }}
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git push origin ${{ steps.bump-semver-tag.outputs.tag }}